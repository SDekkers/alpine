#!/bin/sh

# Script for building and packaging
# Usage ./package -p [7.0|7.1|7.2|7.3|all|{package-name}]

BUILD_PACKAGES="all"

while test $# -gt 0; do
  if test "$1" = "-h" || test "$1" = "--help"; then
    echo "Build script"
    echo ""
    echo "Script for building PHP packages for PHP.earth Alpine Linux"
    echo "repository."
    echo ""
    echo "SYNOPSIS:"
    echo "  package [<options>]"
    echo ""
    echo "OPTIONS:"
    echo "  -h, --help         Display this help."
    echo "  -p, --packages 'package_name...'"
    exit 0;
  fi

  if test "$1" = "-p" || test "$1" = "--packages"; then
    BUILD_PACKAGES="${2}"
  fi

  shift
done

# Set current Alpine version
ALPINE_VERSION=`cat /etc/alpine-release`
ALPINE_VERSION=v${ALPINE_VERSION:0:3}
if test -z "$ALPINE_VERSION"; then
  echo "Alpine version could not be set." >&2
  exit 1
fi

packages_others="
argon2
cmark
composer
gnu-libiconv
libxlsxwriter
litespeed
phpunit
"

packages_70="
php7.0-apcu
php7.0-ast
php7.0-cmark
php7.0-composer
php7.0-ds
php7.0-imagick
php7.0-memcached
php7.0-meminfo
php7.0-mongodb
php7.0-redis
php7.0-sodium
php7.0-swoole
php7.0-xdebug
php7.0-xlswriter
php7.0-yaml
"

packages_71="
php7.1-apcu
php7.1-ast
php7.1-cmark
php7.1-composer
php7.1-ds
php7.1-imagick
php7.1-memcached
php7.1-meminfo
php7.1-mongodb
php7.1-phpunit
php7.1-redis
php7.1-sodium
php7.1-swoole
php7.1-xdebug
php7.1-xlswriter
php7.1-yaml
"

packages_72="
php7.2-apcu
php7.2-ast
php7.2-cmark
php7.2-composer
php7.2-ds
php7.2-imagick
php7.2-mcrypt
php7.2-memcached
php7.2-meminfo
php7.2-mongodb
php7.2-phpunit
php7.2-redis
php7.2-swoole
php7.2-xdebug
php7.2-xlswriter
php7.2-yaml
"

packages_73="
php7.3-apcu
php7.3-ast
php7.3-cmark
php7.3-composer
php7.3-ds
php7.3-imagick
php7.3-memcached
php7.3-meminfo
php7.3-mongodb
php7.3-phpunit
php7.3-redis
php7.3-swoole
php7.3-xdebug
php7.3-xlswriter
php7.3-yaml
"

all="$packages_others $packages_70 $packages_71 $packages_72 $packages_73"

# To build PHP Pecl extensions and some packages, we'll need some deps from the
# local PHP.earth Alpine repository
mkdir -p /public/$ALPINE_VERSION/x86_64
abuild-sign -k /home/packager/.abuild/phpearth.rsa.priv /public/$ALPINE_VERSION/x86_64/APKINDEX.tar.gz
sudo apk update

if [ "$BUILD_PACKAGES" = "7.0" ]; then
  packages=$packages_70
elif [ "$BUILD_PACKAGES" = "7.1" ]; then
  packages=$packages_71
elif [ "$BUILD_PACKAGES" = "7.2" ]; then
  packages=$packages_72
elif [ "$BUILD_PACKAGES" = "7.3" ]; then
  packages=$packages_73
elif [ "$BUILD_PACKAGES" = "all" ]; then
  packages=$all
else
  packages="$BUILD_PACKAGES"
fi

for package in $packages; do
  cd /$ALPINE_VERSION/$package

  # For PHP we also generate tmp directory for some temporary files
  rm -rf tmp

  # Clean pkgdir and srcdir
  abuild clean

  abuild checksum
  abuild -r -K

  # Generate index with trusted signature
  generate-index

  # Clean packages with previous versions
  abuild cleanoldpkg

  # Regenerate index with trusted signature
  generate-index
done
